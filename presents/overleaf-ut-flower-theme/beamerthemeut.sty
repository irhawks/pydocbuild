%
% Latex-Beamer theme for the University of Twente
%
% Author: Jasper Goseling
% Date: May 3, 2011
% Version: 0.1
%
% Requires: Xelatex
%

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{beamerthemeut}[2011/05/13 v0.1 Latex-Beamer theme for the University of Twente]

\mode<presentation>

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% Loading packages
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage{tikz}
\RequirePackage{pgfopts}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% Process package options
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newif\ifUTBeamer@uttitlepage
\UTBeamer@uttitlepagetrue

\newif\ifUTBeamer@euler
\UTBeamer@eulertrue

\newif\ifUTBeamer@debug
\UTBeamer@debugfalse

\pgfkeys{
	/UTBeamer/.cd,
	debug/.is if=UTBeamer@debug,
	uttitlepage/.is if=UTBeamer@uttitlepage,
	euler/.is if=UTBeamer@euler
}


\pgfkeys{
	/UTBeamer/.cd,
	titlepage/.is choice,
	titlepage/A/.style = {
		tp@bgid/.initial=2,
		tpboxax/.initial=10,
		tpboxay/.initial=20,
		tpboxawd/.initial=75,
		tpboxaht/.initial=15,
		tpboxbx/.initial=55,
		tpboxby/.initial=42,
		tpboxbwd/.initial=65,
		tpboxbht/.initial=28,
		tpboxcx/.initial=55,
		tpboxcy/.initial=4,
		tpboxcwd/.initial=37,
		tpboxcht/.initial=10
},
	titlepage/B/.style = {
		tp@bgid=3,
		tpboxax=10,
		tpboxay=15,
		tpboxawd=83,
		tpboxaht=15,
		tpboxbx=25,
		tpboxby=36,
		tpboxbwd=90,
		tpboxbht=17,
		tpboxcx=45,
		tpboxcy=66,
		tpboxcwd=45,
		tpboxcht=25
},
	titlepage/C/.style = {
		tp@bgid=4,
		tpboxax=10,
		tpboxay=20,
		tpboxawd=75,
		tpboxaht=15,
		tpboxbx=30,
		tpboxby=42,
		tpboxbwd=65,
		tpboxbht=28,
		tpboxcx=95,
		tpboxcy=50,
		tpboxcwd=37,
		tpboxcht=10
},
	titlepage/D/.style = {
		tp@bgid=5,
		tpboxax=10,
		tpboxay=20,
		tpboxawd=75,
		tpboxaht=15,
		tpboxbx=45,
		tpboxby=42,
		tpboxbwd=65,
		tpboxbht=28,
		tpboxcx=45,
		tpboxcy=66,
		tpboxcwd=45,
		tpboxcht=25
},
titlepage=A % Sets the default to A. This also ensures that all keys get defined/initialized
}



\ProcessPgfOptions{/UTBeamer} % process the package/style options




\newcommand\utbeamerset[1]{\pgfkeys{/UTBeamer/.cd, #1}}
% for user convenience, use for instance in the document preamble as
% \utbeamerset{tpboxbx=10,tpboxby=20}




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% Loading additional packages
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% \RequirePackage[T1]{fontenc}

\ifUTBeamer@euler
% 	\RequirePackage{eulervm}
	\RequirePackage{euler}
\fi


\RequirePackage{ifxetex}
\ifxetex
	\RequirePackage[cm-default]{fontspec}
\fi
% \RequirePackage{appendixnumberbeamer} % included in this file




\RequirePackage[absolute,overlay]{textpos}
\setlength{\TPHorizModule}{1mm}
\setlength{\TPVertModule}{1mm}
\textblockorigin{0mm}{0mm} % start everything near the top-left corner









%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% Colors
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\definecolor{utgreen}{RGB}{52, 178, 51}
\definecolor{utmagenta}{RGB}{207, 0, 114}
\definecolor{utyellow}{RGB}{254, 209, 0}
\definecolor{utblue}{RGB}{0, 152, 195}
\definecolor{utred}{RGB}{220, 12, 48}
\definecolor{utforest}{RGB}{0, 106, 77}
\definecolor{utpurple}{RGB}{79, 45, 127}
\definecolor{utgold}{RGB}{136, 123, 27}
\definecolor{utnavy}{RGB}{0, 44, 95}
\definecolor{utgray}{RGB}{97, 82, 88}

% for compatibility
\definecolor{utlightgreen}{RGB}{52, 178, 51}
\definecolor{utlightpurple}{RGB}{207, 0, 114}
\definecolor{utlightyellow}{RGB}{254, 209, 0}
\definecolor{utlightblue}{RGB}{0, 152, 195}
\definecolor{utpink}{RGB}{220, 12, 48}
\definecolor{utdarkgreen}{RGB}{0, 106, 77}
\definecolor{utdarkpurple}{RGB}{79, 45, 127}
\definecolor{utdarkyellow}{RGB}{136, 123, 27}
\definecolor{utdarkblue}{RGB}{0, 44, 95}


\setbeamercolor{structure}{fg=black,bg=white}
\setbeamercolor{alerted text}{fg=utred}


%%% Start of Rose
\setbeamercolor{block title}{use=structure,fg=structure.fg,bg=structure.fg!20!bg}
\setbeamercolor{block title alerted}{use=alerted text,fg=alerted text.fg,bg=alerted text.fg!20!bg}
\setbeamercolor{block title example}{use=example text,fg=example text.fg,bg=example text.fg!20!bg}

\setbeamercolor{block body}{parent=normal text,use=block title,bg=block title.bg!50!bg}
\setbeamercolor{block body alerted}{parent=normal text,use=block title alerted,bg=block title alerted.bg!50!bg}
\setbeamercolor{block body example}{parent=normal text,use=block title example,bg=block title example.bg!50!bg}
%%% end of Rose



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% Fonts
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\setbeamerfont*{footline}{\size=\Large}
%\setsansfont[Mapping=tex-text,Scale=0.8]{Arial}
%\newfontfamily\narrowfamily[Mapping=tex-text,Scale=1.0]{Arial Narrow}
%\setbeamerfont*{frametitle}{family=\narrowfamily,size=\Large}

\ifxetex
	\setsansfont[Mapping=tex-text,Scale=0.8]{Arial}
% 	\setsansfont[Mapping=tex-text,Scale=1.0]{Arial Narrow}
	\newfontfamily\narrowfamily[Mapping=tex-text,Scale=1.0]{Arial}
	\setbeamerfont*{frametitle}{family=\narrowfamily,size=\Large}
	\setbeamerfont*{footline}{family=\narrowfamily,size=\scriptsize}
	\setbeamerfont*{title}{family=\narrowfamily,size=\Large}
	\setbeamerfont*{subtitle}{family=\narrowfamily,size=\normalsize}
	\setbeamerfont*{author}{family=\narrowfamily,size=\normalsize}
	\setbeamerfont*{institute}{family=\narrowfamily,size=\normalsize}
	\setbeamerfont*{date}{family=\narrowfamily,size=\normalsize}
\else
	\setbeamerfont*{frametitle}{size=\Large}
	\setbeamerfont*{footline}{size=\scriptsize}
	\setbeamerfont*{title}{size=\Large}
	\setbeamerfont*{author}{size=\normalsize}
	\setbeamerfont*{institute}{size=\normalsize}
	\setbeamerfont*{date}{size=\normalsize}
\fi

\setbeamerfont*{alerted text}{series=\bfseries}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% Frame (inner/outer)
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\setbeamertemplate{navigation symbols}{}
\useinnertheme{rounded}
\setbeamertemplate{itemize items}[triangle]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Frametitle
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\defbeamertemplate*{frametitle}{}{
\usebeamerfont{frametitle}\vspace{1.5ex}\insertframetitle\\[-.5ex] \rule{\textwidth}{.3pt}\rlap{\rule{\beamer@rightmargin}{.3pt}}
} % the rule consists of two parts, the last part does not occupy any space (\rlap) in order not to cause an overfull hbox

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Footline
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcommand{\footlinetext}[1]{\def\insertfootlinetext{#1}}

\defbeamertemplate*{footline}{}{
\hspace{\beamer@leftmargin}
\hspace{-4.6ex}
\includegraphics[height=7mm,page=1]{beamerthemeutresources}
\hspace*{2ex}
\hfill
\begin{beamercolorbox}[ht=2cm,wd=9cm,sep=0cm]{fg=black,bg=red}  
\hfill
%  [ \insertshortauthor, \insertshortinstitute\ ]
\insertfootlinetext
\hspace{2ex}
\insertframenumber/\inserttotalframenumber
\hspace*{\beamer@rightmargin}
\vspace*{1.5ex}
\end{beamercolorbox}
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% Chapterframe
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newenvironment{chapterframe}
{
\begin{frame}[plain]
\begin{tikzpicture}[remember picture,overlay]
% \node at (current page.center) {\includegraphics[width=130mm]{title_background_1}};
\node[anchor=south west,xshift=-1.2mm,yshift=-1.5mm] at (current page.south west) {\includegraphics[height=1.02\paperheight,page=6]{beamerthemeutresources}};
\end{tikzpicture}
\begin{minipage}{1cm}
\tikz\path (0,0) -- (1,1);
\end{minipage}
% \hfill
% \begin{minipage}{.77\textwidth}
\minipage{9.4cm}
}{
\endminipage
% \end{minipage}
\end{frame}
}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% Title page
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\ifUTBeamer@debug
	\setbeamercolor{titlepage box}{fg=white,bg=utpink}
\else
	\setbeamercolor{titlepage box}{fg=white}
\fi


\defbeamertemplate*{title page}{ut}
{
% \usebeamercolor{

\begin{tikzpicture}[remember picture,overlay]
\node at (current page.center) {\includegraphics[width=130mm,page=\pgfkeysvalueof{/UTBeamer/tp@bgid}]{beamerthemeutresources}};
\end{tikzpicture}



\begin{textblock}{1000}(\pgfkeysvalueof{/UTBeamer/tpboxax},\pgfkeysvalueof{/UTBeamer/tpboxay})
\begin{beamercolorbox}[wd=\pgfkeysvalueof{/UTBeamer/tpboxawd} mm,ht=\pgfkeysvalueof{/UTBeamer/tpboxaht} mm]{titlepage box}
\vfill
\usebeamerfont{title}\inserttitle

\usebeamerfont{subtitle}\insertsubtitle
% \vfill\vbox{}
\end{beamercolorbox}
\end{textblock}

\begin{textblock}{1000}(\pgfkeysvalueof{/UTBeamer/tpboxbx},\pgfkeysvalueof{/UTBeamer/tpboxby})
\begin{beamercolorbox}[wd=\pgfkeysvalueof{/UTBeamer/tpboxbwd} mm,ht=\pgfkeysvalueof{/UTBeamer/tpboxbht} mm]{titlepage box}
\usebeamerfont{author}\insertauthor\\[1mm]
\usebeamerfont{institute}\insertinstitute\\[1mm]
\usebeamerfont{date}\insertdate
\vfill{}
\end{beamercolorbox}
\end{textblock}

\begin{textblock}{1000}(\pgfkeysvalueof{/UTBeamer/tpboxcx},\pgfkeysvalueof{/UTBeamer/tpboxcy})
\begin{beamercolorbox}[wd=\pgfkeysvalueof{/UTBeamer/tpboxcwd} mm,ht=\pgfkeysvalueof{/UTBeamer/tpboxcht} mm]{titlepage box}
\inserttitlegraphic
\end{beamercolorbox}
\end{textblock}

} %\defbeamertemplate*{title page}{ut}

\ifUTBeamer@uttitlepage
	\def\beamer@andinst{\\[1mm]} % TODO: there are many instances of \\[1mm]
	% This is used internally by beamer in \insertinstitute if there are multiple institutions. The default value was producing to much white space.
	\setbeamercolor{title page}{fg=white, bg=black}
	\setbeamertemplate{title page}[ut]
\else
	\setbeamertemplate{title page}[default]
\fi




% Redefine maketitle to ensure that the titlepage is 'plain'
\def\maketitle{\ifbeamer@inframe\titlepage\else\frame[plain]{\titlepage}\fi}











%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% appendixnumberbeamer.sty
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% Jï¿½rï¿½me Lelong (September 2007)
%% 
%% this stuff fixes the frame numbering in beamer when using an appendix such
%% that the slides of the appendix are not counted in the total framenumber

\let\appendixtotalframenumber\empty
\def\mainend{-1}
\let\appendixorig\appendix

\def\appendix{
  \edef\mainend{\theframenumber}
  \immediate\write\@auxout{\string\global\string\@namedef{mainendframenumber}{\mainend}}
  \appendixorig
  \def\inserttotalframenumber{\appendixtotalframenumber}%
  \setcounter{framenumber}{0}
}

\def\pageatend{
  \edef\appendixend{\theframenumber}
  \ifnum\mainend>0%
  \immediate\write\@auxout{\string\global\string\@namedef{appendixtotalframenumber}{\appendixend}}%
  \immediate\write\@auxout{\string\global\string\@namedef{inserttotalframenumber}{\mainend}}%
  \immediate\write\@auxout{\string\@writefile{nav}{\noexpand \headcommand {%
        \noexpand \def\noexpand \inserttotalframenumber{\mainend}}}}%
  \immediate\write\@auxout{\string\@writefile{nav}{\noexpand \headcommand {%
        \noexpand \def\noexpand \appendixtotalframenumber{\appendixend}}}}%
  \else
  \fi
}


\AtEndDocument{\pageatend}











%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% THE END
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



\mode<all>
